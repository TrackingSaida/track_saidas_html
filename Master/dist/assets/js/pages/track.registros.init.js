!function(){function t(t){return document.querySelector(t)}var e=function(t){return Array.prototype.slice.call(document.querySelectorAll(t))},n={from:t("#flt-from"),to:t("#flt-to"),entregador:t("#flt-entregador"),status:t("#flt-status"),codigo:t("#flt-codigo"),sort:t("#flt-sort"),pageSize:t("#flt-pageSize")},o=t("#reg-rows"),a=t("#chk-all"),r=t("#btn-search"),i=t("#btn-bulk-delete"),d=t("#pager-info"),c=t("#pager-prev"),s=t("#pager-next"),u={page:1,pageSize:20,total:0,rows:[]};function l(t,e){void 0===e&&(e=!0),console[e?"log":"warn"](e?"✅":"⚠️",t)}function g(t){o&&(t&&t.length?(o.innerHTML=t.map(function(t){return'<tr data-id="'+t.id+'"><td><input type="checkbox" class="rowchk form-check-input" /></td><td>'+(t.tsFmt||"")+"</td><td>"+(t.entregador||"")+"</td><td>"+(t.codigo||"")+"</td><td>"+(t.servico||"")+"</td><td>"+(t.status||"")+"</td><td>"+(t.duplicado?"Sim":"Não")+"</td><td>"+(t.estacao||"")+'</td><td class="text-end"><button class="btn btn-sm btn-soft-primary me-1 btn-edit">Editar</button><button class="btn btn-sm btn-soft-danger btn-del">Excluir</button></td></tr>'}).join(""),e(".btn-edit").forEach(function(o){o.addEventListener("click",function(){var e,t=o.closest("tr");t&&(e=t.getAttribute("data-id"),f)&&(t=(u.rows||[]).find(function(t){return String(t.id)===String(e)}))&&(p.id&&(p.id.value=t.id||""),p.entregador&&(p.entregador.value=t.entregador||""),p.codigo&&(p.codigo.value=t.codigo||""),p.servico&&(p.servico.value=t.servico||""),p.status&&(p.status.value=t.status||""),p.estacao&&(p.estacao.value=t.estacao||""),f.show())})}),e(".btn-del").forEach(function(o){o.addEventListener("click",function(){var t,e=o.closest("tr");e&&(t=e.getAttribute("data-id"),confirm("Excluir este registro?"))&&window.TrackAPI.deleteSaida(t).then(function(t){t&&t.ok?(e.remove(),l("Excluído."),v()):l(t&&t.error||"Falha",!1)})})})):o.innerHTML='<tr><td colspan="9" class="text-muted text-center py-4">Sem registros.</td></tr>')}function v(){var t={page:u.page,pageSize:parseInt(n.pageSize&&n.pageSize.value||"20",10),from:n.from&&n.from.value||"",to:n.to&&n.to.value||"",entregador:n.entregador&&n.entregador.value||"",status:n.status&&n.status.value||"",codigo:n.codigo&&n.codigo.value||"",sort:n.sort&&n.sort.value||"-ts"};window.TrackAPI.listSaidas(t).then(function(t){t&&t.ok?(u.page=t.page,u.pageSize=t.pageSize,u.total=t.total,u.rows=t.rows||[],g(u.rows),d&&(d.textContent="Página "+t.page+" • "+(t.rows?t.rows.length:0)+" de "+t.total),a&&(a.checked=!1)):l(t&&t.error||"Falha ao listar",!1)})}c&&c.addEventListener("click",function(){1<u.page&&(u.page--,v())}),s&&s.addEventListener("click",function(){var t=Math.ceil((u.total||0)/(u.pageSize||20))||1;u.page<t&&(u.page++,v())}),r&&r.addEventListener("click",function(){u.page=1,v()}),a&&a.addEventListener("change",function(){e(".rowchk").forEach(function(t){t.checked=a.checked})}),i&&i.addEventListener("click",function(){var t=e(".rowchk:checked").map(function(t){t=t.closest("tr");return t?t.getAttribute("data-id"):null}).filter(Boolean);t.length?confirm("Excluir "+t.length+" registro(s)?")&&window.TrackAPI.bulkDelete(t).then(function(t){t&&t.ok?(l("Excluídos: "+t.count),v()):l(t&&t.error||"Falha",!1)}):l("Selecione ao menos 1 registro",!1)});var c=document.getElementById("editModal"),f=c?new bootstrap.Modal(c):null,p={id:document.getElementById("edit-id"),entregador:document.getElementById("edit-entregador"),codigo:document.getElementById("edit-codigo"),servico:document.getElementById("edit-servico"),status:document.getElementById("edit-status"),estacao:document.getElementById("edit-estacao"),btnSave:document.getElementById("edit-save")};p.btnSave&&p.btnSave.addEventListener("click",function(){var t,e=(p.codigo&&p.codigo.value||"").replace(/\D+/g,"");/^\d{44}$/.test(e)?(l("Código inválido (NF-e). Leia a etiqueta do marketplace.",!1),p.codigo&&p.codigo.focus()):(e={entregador:(p.entregador&&p.entregador.value||"").trim(),codigo:(p.codigo&&p.codigo.value||"").trim(),servico:(p.servico&&p.servico.value||"").trim(),status:p.status&&p.status.value||"",estacao:(p.estacao&&p.estacao.value||"").trim()},t=p.id?p.id.value:null,window.TrackAPI.updateSaida(t,e).then(function(t){t&&t.ok?(f&&f.hide(),l("Atualizado."),v()):l(t&&t.error||"Falha ao salvar",!1)}))}),window.TrackAPI&&window.TrackAPI.getConfig().then(function(t){var e=t&&t.entregadores||[],o=(n.entregador.innerHTML=['<option value="">(Todos)</option>'].concat(e.map(function(t){return"<option>"+t+"</option>"})).join(""),document.getElementById("edit-entregadores")),o=(o&&(o.innerHTML=e.map(function(t){return'<option value="'+t+'"></option>'}).join("")),document.getElementById("edit-estacoes")),e=t&&t.estacoes||[];o&&(o.innerHTML=e.map(function(t){return'<option value="'+t+'"></option>'}).join(""))}),v()}();